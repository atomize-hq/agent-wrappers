# C2-spec – Wrapper Coverage Generator (`wrapper_coverage.json`)

## Scope
- Implement deterministic generation of `cli_manifests/codex/wrapper_coverage.json` that describes wrapper support at the command/flag/arg level (ADR 0002 coverage levels + scope semantics).
- The wrapper coverage file must not be hand-edited JSON; it must be generated by tooling (normative command below) from a single source-of-truth declaration in wrapper code.
- Coverage levels must support: `explicit|passthrough|unsupported|intentionally_unsupported|unknown`.
- Scope semantics (normative) must follow `RULES.json.wrapper_coverage.*`:
  - `no scope` means “all expected targets”.
  - If a surface includes `platforms`, expand to expected targets using `RULES.json.union.platform_mapping`.
  - Resolution requires a single best match per unit (multi-match is a hard error; no-match treated as unknown).
  - Overlapping scopes for the same unit are disallowed (manifest invalid).
- Intentionally unsupported entries require a `note` rationale (per ADR 0002 + RULES).

## Source of Truth (normative)

Wrapper coverage declarations must live in a single Rust module:
- `crates/codex/src/wrapper_coverage_manifest.rs`

The module must define a single exported value that acts as the only source of truth:
- `pub fn wrapper_coverage_manifest() -> WrapperCoverageManifestV1`
  - where `WrapperCoverageManifestV1` matches `cli_manifests/codex/SCHEMA.json` (`WrapperCoverageManifestV1`).

No other files should embed wrapper coverage declarations.

## Command Interface (normative)

### `xtask codex-wrapper-coverage`

Invocation:
- `cargo run -p xtask -- codex-wrapper-coverage --out cli_manifests/codex/wrapper_coverage.json`

CLI:
- `--out <FILE>` (required)
- `--rules <FILE>` (default: `cli_manifests/codex/RULES.json`) (used for expected_targets ordering + timestamp policy)

Output:
- Writes `cli_manifests/codex/wrapper_coverage.json` (schema `WrapperCoverageManifestV1`).
- `generated_at` must be deterministic in CI via `SOURCE_DATE_EPOCH` (see `cli_manifests/codex/RULES.json.timestamps`).
- `wrapper_version` must be the wrapper crate version (from `crates/codex/Cargo.toml`), not the upstream codex version.
- All arrays must be sorted deterministically per `cli_manifests/codex/RULES.json.sorting`.
- Output must be pretty-printed JSON with a trailing newline.

## Testing Contract (normative)

All tests for this triad must live under:
- `crates/xtask/tests/`

Minimum required tests:
- determinism: same input → byte-identical output
- scope resolution: overlap detection and multi-match failures are caught by `xtask codex-validate` (C0)

## Acceptance Criteria
- `cli_manifests/codex/wrapper_coverage.json` is generated deterministically (byte-stable given unchanged code).
- The file validates against `cli_manifests/codex/SCHEMA.json` (`WrapperCoverageManifestV1`).
- Overlapping scopes are rejected by `xtask codex-validate` (C0 validator) with the required error details.

## Out of Scope
- Upstream snapshot generation/union merge.
- Coverage report generation.
- CI workflow changes.
